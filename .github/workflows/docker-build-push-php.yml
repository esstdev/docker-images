name: esst/php

on:
  push:
    branches:
      - main
  release:
    types:
      - created
  schedule:
    - cron: '0 1 * * 1'

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      php_version: ${{ steps.set_job_output.outputs.version }}
    steps:
      - name: Extract PHP version from tag (for release)
        id: extract_version
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            version="$(echo "$GITHUB_REF" | grep -oP '(?<=php-)\d+\.\d+')"
            echo "VERSION=$version" >> $GITHUB_ENV
          else
            # If not a release, build ALL versions
            echo "VERSION=all" >> $GITHUB_ENV
          fi

      - name: Set job output
        id: set_job_output
        shell: bash
        run: echo "version=${VERSION:-all}" >> $GITHUB_OUTPUT

  # ============================================================================================
  # BUILD & PUSH AMD64 - FPM ALPINE
  # ============================================================================================
  build-test-and-push-amd64-fpm:
    runs-on: ubuntu-latest
    needs: prepare
    if: contains(github.ref, 'php-') || github.event_name == 'schedule' || github.event_name == 'push'
    strategy:
      matrix:
        php_version: [ 8.4, 8.5 ]
    steps:
      - name: Skip non-matching versions on release
        if: (github.event_name == 'release' || github.event_name == 'push') && matrix.php_version != needs.prepare.outputs.php_version
        run: exit 0

      - name: Check out code
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_PASSWORD }}

      - name: Build AMD64 FPM-Alpine (not pushed yet)
        run: |
          docker build \
            --platform linux/amd64 \
            --progress=plain \
            -t esst/php:${{ matrix.php_version }}-fpm-alpine-amd64 \
            -f ./php/${{ matrix.php_version }}/fpm-alpine/Dockerfile \
            .

      - name: Run container for testing
        run: docker run -d --name fpm_alpine_test_${{ matrix.php_version }} esst/php:${{ matrix.php_version }}-fpm-alpine-amd64

      - name: Check PHP extensions
        run: |
          extensions=("bcmath" "exif" "gd" "intl" "ldap" "pcntl" "pdo_mysql" "xml" "mbstring" "curl" "zip" "imagick" "redis")
          for ext in "${extensions[@]}"; do
            if ! docker exec fpm_alpine_test_${{ matrix.php_version }} php -m | grep -wq "$ext"; then
              echo "$ext extension is NOT installed"
              exit 1
            fi
          done
          echo "All required extensions are installed"

      - name: Save test FPM image
        run: docker save -o fpm_test_${{ matrix.php_version }}.tar esst/php:${{ matrix.php_version }}-fpm-alpine-amd64

      - name: Upload test FPM artifact
        uses: actions/upload-artifact@v5
        with:
          name: fpm_test_${{ matrix.php_version }}
          path: fpm_test_${{ matrix.php_version }}.tar
          retention-days: 1

      - name: Push Tested AMD64 FPM-Alpine
        run: docker push esst/php:${{ matrix.php_version }}-fpm-alpine-amd64

  # ============================================================================================
  # BUILD & PUSH AMD64 - FPM + NGINX ALPINE
  # ============================================================================================
  build-test-and-push-amd64-nginx:
    runs-on: ubuntu-latest
    needs: [ prepare, build-test-and-push-amd64-fpm ]
    if: contains(github.ref, 'php-') || github.event_name == 'schedule' || github.event_name == 'push'
    strategy:
      matrix:
        php_version: [ 8.4, 8.5 ]
    steps:
      - name: Skip non-matching versions on release
        if: (github.event_name == 'release' || github.event_name == 'push') && matrix.php_version != needs.prepare.outputs.php_version
        run: exit 0

      - name: Check out code
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_PASSWORD }}

      - name: Download FPM test image
        uses: actions/download-artifact@v5
        with:
          name: fpm_test_${{ matrix.php_version }}

      - name: Load FPM test image
        run: docker load -i fpm_test_${{ matrix.php_version }}.tar

      - name: Build AMD64 FPM-Nginx-Alpine
        env:
          DOCKER_BUILDKIT: 1
        run: |
          docker build \
            --progress=plain \
            -t esst/php:${{ matrix.php_version }}-fpm-nginx-alpine-amd64 \
            -f ./php/${{ matrix.php_version }}/fpm-alpine/Dockerfile.nginx \
            .

      - name: Push AMD64 Nginx Image
        run: docker push esst/php:${{ matrix.php_version }}-fpm-nginx-alpine-amd64

  # ============================================================================================
  # BUILD & PUSH ARM64 - FPM ALPINE
  # ============================================================================================
  build-and-push-arm64-fpm:
    runs-on: ubuntu-24.04-arm
    needs: [ prepare, build-test-and-push-amd64-fpm ]
    if: contains(github.ref, 'php-') || github.event_name == 'schedule' || github.event_name == 'push'
    strategy:
      matrix:
        php_version: [ 8.4, 8.5 ]
    steps:
      - name: Skip non-matching versions on release
        if: (github.event_name == 'release' || github.event_name == 'push') && matrix.php_version != needs.prepare.outputs.php_version
        run: exit 0

      - name: Check out code
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_PASSWORD }}

      - name: Build ARM64 FPM-Alpine (local)
        env:
          DOCKER_BUILDKIT: 1
        run: |
          docker build \
            --platform linux/arm64 \
            --progress=plain \
            -t esst/php:${{ matrix.php_version }}-fpm-alpine-arm64 \
            -f ./php/${{ matrix.php_version }}/fpm-alpine/Dockerfile \
            .

      - name: Save ARM64 FPM image
        run: docker save -o fpm_test_arm64_${{ matrix.php_version }}.tar esst/php:${{ matrix.php_version }}-fpm-alpine-arm64

      - name: Upload ARM64 FPM artifact
        uses: actions/upload-artifact@v5
        with:
          name: fpm_test_arm64_${{ matrix.php_version }}
          path: fpm_test_arm64_${{ matrix.php_version }}.tar
          retention-days: 1

      - name: Push ARM64 FPM Image
        run: docker push esst/php:${{ matrix.php_version }}-fpm-alpine-arm64

  # ============================================================================================
  # BUILD & PUSH ARM64 - FPM + NGINX ALPINE
  # ============================================================================================
  build-and-push-arm64-nginx:
    runs-on: ubuntu-24.04-arm
    needs: [ prepare, build-and-push-arm64-fpm, build-test-and-push-amd64-nginx ]
    if: contains(github.ref, 'php-') || github.event_name == 'schedule' || github.event_name == 'push'
    strategy:
      matrix:
        php_version: [ 8.4, 8.5 ]
    steps:
      - name: Skip non-matching versions on release
        if: (github.event_name == 'release' || github.event_name == 'push') && matrix.php_version != needs.prepare.outputs.php_version
        run: exit 0

      - name: Check out code
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_PASSWORD }}

      - name: Download ARM64 FPM test image
        uses: actions/download-artifact@v5
        with:
          name: fpm_test_arm64_${{ matrix.php_version }}

      - name: Load ARM64 FPM test image
        run: docker load -i fpm_test_arm64_${{ matrix.php_version }}.tar

      - name: Build ARM64 FPM-Nginx-Alpine
        env:
          DOCKER_BUILDKIT: 1
        run: |
          docker build \
            --progress=plain \
            -t esst/php:${{ matrix.php_version }}-fpm-nginx-alpine-arm64 \
            -f ./php/${{ matrix.php_version }}/fpm-alpine/Dockerfile.nginx \
            .

      - name: Push ARM64 Nginx Image
        run: docker push esst/php:${{ matrix.php_version }}-fpm-nginx-alpine-arm64

  # ============================================================================================
  # FINALIZE: MERGE MULTI-ARCH
  # ============================================================================================
  finalize-multiarch:
    runs-on: ubuntu-latest
    needs:
      - build-test-and-push-amd64-fpm
      - build-test-and-push-amd64-nginx
      - build-and-push-arm64-fpm
      - build-and-push-arm64-nginx
    if: contains(github.ref, 'php-') || github.event_name == 'schedule' || github.event_name == 'push'
    strategy:
      matrix:
        php_version: [ 8.4, 8.5 ]
        variant: [ fpm-alpine, fpm-nginx-alpine ]
    steps:
      - name: Skip non-matching versions on release
        if: (github.event_name == 'release' || github.event_name == 'push') && matrix.php_version != needs.prepare.outputs.php_version
        run: exit 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_PASSWORD }}

      - name: Merge Multi-Arch Images
        run: |
          docker buildx imagetools create \
            -t esst/php:${{ matrix.php_version }}-${{ matrix.variant }} \
            esst/php:${{ matrix.php_version }}-${{ matrix.variant }}-amd64 \
            esst/php:${{ matrix.php_version }}-${{ matrix.variant }}-arm64
